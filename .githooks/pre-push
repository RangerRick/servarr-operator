#!/usr/bin/env bash
set -euo pipefail

# Pre-push hook: fail if code coverage has regressed below the threshold.
# Enable with: git config core.hooksPath .githooks

REPO_ROOT="$(git rev-parse --show-toplevel)"
THRESHOLD_FILE="$REPO_ROOT/.coverage-threshold"

if [[ ! -f "$THRESHOLD_FILE" ]]; then
    echo "pre-push: .coverage-threshold file not found, skipping coverage check"
    exit 0
fi

THRESHOLD=$(cat "$THRESHOLD_FILE")

if ! command -v cargo-llvm-cov &>/dev/null; then
    echo "pre-push: cargo-llvm-cov not installed, skipping coverage check"
    echo "  Install with: cargo install cargo-llvm-cov"
    exit 0
fi

echo "pre-push: running coverage check (threshold: ${THRESHOLD}% lines)..."

if ! cargo llvm-cov --workspace --fail-under-lines "$THRESHOLD" --summary-only; then
    echo ""
    echo "pre-push: BLOCKED â€” line coverage dropped below ${THRESHOLD}%"
    echo "  Run 'cargo llvm-cov --workspace --summary-only' for details."
    exit 1
fi

echo "pre-push: coverage check passed"
