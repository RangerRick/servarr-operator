name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: read

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.v.outputs.semver }}
      tag: ${{ steps.v.outputs.tag }}
    steps:
      - name: Compute version from tag
        id: v
        run: |
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "semver=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

  ci:
    uses: ./.github/workflows/_ci.yaml
    with:
      artifact-retention-days: 5

  publish:
    needs: [version, ci]
    permissions:
      contents: write
      packages: write
    uses: ./.github/workflows/_publish.yaml
    with:
      image-tags: |-
        ${{ needs.version.outputs.tag }}
        latest
      image-version-label: ${{ needs.version.outputs.semver }}
      chart-version: ${{ needs.version.outputs.semver }}
      chart-app-version: ${{ needs.version.outputs.tag }}
      create-github-release: true
      release-tag: ${{ needs.version.outputs.tag }}
